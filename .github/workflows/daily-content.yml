name: Daily Medical Content Generation

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-dejavu-core fonts-liberation
      
      - name: Install Python dependencies
        run: |
          pip install openai Pillow requests edge-tts google-auth google-auth-oauthlib google-api-python-client
      
      - name: Run medical education workflow
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          python main.py
      
      - name: Commit database updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add medical_education.db || true
          git diff --staged --quiet || git commit -m "Update database with daily content"
          git push || true
